---
output: github_document
bibliography: README.bib
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  cache.path = "cache/README-",
  out.width = "100%")
options(digits = 3)
```
# survTMB

This package contains methods to estimated mixed generalized survival 
models [@Liu16;@Liu17]. All methods use automatic differentiation using 
the CppAD library [@Bell19] through the TMB package [@Kristensen16]. The 
estimation methods are 

 - A Laplace approximation method using TMB. 
 - Gaussian variational approximation (GVA) similar to the method shown 
   by @Ormerod12. 
 - Skew-normal variational approximation (SNVA) similar to the method shown
   by @Ormerod11.
   
The [example](#example) section shows an example of how to use the package
with different methods. The [benchmark](#benchmark) section shows a 
comparison of the computation time of the methods.

## Example

We estimate a GSM using different link functions and different methods 
below. First, we define function to perform the estimation. Then we use 
the different methods with models using various link functions.

```{r fit_example, cache = 1}
dat <- coxme::eortc

library(survTMB)
library(survival)
fit_model <- function(link, n_threads = 2L, method = "Laplace", 
                      param_type = "DP"){
  eval(bquote({
    adfun <- make_gsm_ADFun(
      Surv(y, uncens) ~ trt, cluster = as.factor(center), 
      Z = ~ trt, df = 3L, data = dat, link = .(link), do_setup = .(method), 
      n_threads = .(n_threads), param_type = .(param_type))
    fit <- fit_mgsm(adfun, method = .(method))
    list(fit = fit, fun = adfun)
  }), parent.frame())
}

######
# w/ Laplace
(lap_ph <- fit_model("PH"    ))$fit
fit_model("PO"    )$fit
fit_model("probit")$fit

######
# w/ GVA
(gva_fit <- fit_model("PH"    , method = "GVA"))$fit
fit_model("PO"    , method = "GVA")$fit
fit_model("probit", method = "GVA")$fit

# the GVA solutions seems to be better. First, we print a log-likelihood 
# approximation using the Laplace approximation at the GVA solution
print(-lap_ph$fun$laplace$fn(gva_fit$fit$params), digits = 7)
# then we print the log-likelihood approximation at the Laplace solution
-lap_ph$fit$optim$value

######
# w/ SNVA (DP: direct parameterization)
fit_model("PH"    , method = "SNVA", param_type = "DP")$fit
fit_model("PO"    , method = "SNVA", param_type = "DP")$fit
fit_model("probit", method = "SNVA", param_type = "DP")$fit

######
# w/ SNVA (CP: centralized parameterization)
fit_model("PH"    , method = "SNVA", param_type = "CP_trans")$fit
fit_model("PO"    , method = "SNVA", param_type = "CP_trans")$fit
fit_model("probit", method = "SNVA", param_type = "CP_trans")$fit
```

## Benchmark
We provide a benchmark of the estimation methods used in section 
[example](#example) below.

```{r load_micro}
library(microbenchmark)
```

```{r comp_time, cache = 1, dependson = "fit_example"}
for(mth in c("Laplace", "GVA")){
  msg <- sprintf("Method: %s", mth)
  cat(sprintf("\n%s\n%s\n", msg, 
              paste0(rep("-", nchar(msg)), collapse = "")))
  print(microbenchmark(
    `PH         ` = fit_model("PH"    , 1L, mth),
    `PH     (2L)` = fit_model("PH"    , 2L, mth),
    `PH     (4L)` = fit_model("PH"    , 4L, mth),
    
    `PO         ` = fit_model("PO"    , 1L, mth),
    `PO     (2L)` = fit_model("PO"    , 2L, mth),
    `PO     (4L)` = fit_model("PO"    , 4L, mth), 
    
    `probit     ` = fit_model("probit", 1L, mth),
    `probit (2L)` = fit_model("probit", 2L, mth),
    `probit (4L)` = fit_model("probit", 4L, mth),
    times = 5))
}
```

```{r SNVA_comp_time, cache = 1, dependson = "fit_example"}
for(param_type in c("DP", "CP_trans")){
  mth <- "SNVA"
  msg <- sprintf("Method: %s (%s)", mth, param_type)
  cat(sprintf("\n%s\n%s\n", msg, 
              paste0(rep("-", nchar(msg)), collapse = "")))
  print(microbenchmark(
    `PH         ` = fit_model("PH"    , 1L, mth, param_type = param_type),
    `PH     (2L)` = fit_model("PH"    , 2L, mth, param_type = param_type),
    `PH     (4L)` = fit_model("PH"    , 4L, mth, param_type = param_type),
    
    `PO         ` = fit_model("PO"    , 1L, mth, param_type = param_type),
    `PO     (2L)` = fit_model("PO"    , 2L, mth, param_type = param_type),
    `PO     (4L)` = fit_model("PO"    , 4L, mth, param_type = param_type), 
    
    `probit     ` = fit_model("probit", 1L, mth, param_type = param_type),
    `probit (2L)` = fit_model("probit", 2L, mth, param_type = param_type),
    `probit (4L)` = fit_model("probit", 4L, mth, param_type = param_type),
    times = 5))
}
```

## References
